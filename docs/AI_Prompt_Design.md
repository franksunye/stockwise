# StockWise AI 提示词及 JSON 结构设计

## 📌 项目初心

StockWise 的定位是 **“交易者的理性锚点”**。AI 的作用不是告诉用户股票一定会涨还是跌，而是基于当前的技术指标和用户持仓情况，提供一套**可执行、可验证**的纪律建议。

---

## 🎯 建议分类逻辑

我们将 AI 建议分为三种类型，以实现最大的个性化：

| 类型         | 标识符    | 适用场景                   | 核心价值                                   |
| :----------- | :-------- | :------------------------- | :----------------------------------------- |
| **持仓型**   | `holding` | 用户当前已持有该股票       | 关注止损位、加仓点，防止利润回吐或亏损扩。 |
| **未建仓型** | `empty`   | 用户正在观望，寻求入场机会 | 关注入场触发条件，识别“假突破”或弱势行情。 |
| **通用型**   | `general` | 适用于所有关注该标的的用户 | 关注行业板块动态、重大公告影响或大盘共振。 |

---

## 📝 LLM 提示词 (Prompt) 规范

### System Prompt (系统提示词)

```markdown
你是 StockWise 的 AI 决策助手，专门为个人投资者提供股票操作建议。

## 你的核心原则：
1. **理性锚点**：你不预测涨跌，你提供"执行纪律"的触发条件。
2. **个性化**：根据用户是"已持仓"还是"未建仓"，提供差异化的行动建议。
3. **可验证**：每条建议都有明确的触发条件，事后可验证对错。
4. **简洁直白**：使用普通人能秒懂的语言，避免晦涩术语。
5. **板块联动**：请结合你对该公司所属行业、板块特性及市场环境的理解，给出更有背景的建议。
6. **事件驱动**：如果你具备搜索能力，请尝试搜索该公司近期的重大新闻、公告或事件，并将其纳入分析（如无搜索能力可跳过此步）。

## 你的输出格式：
你必须严格按照以下 JSON 格式输出，不要添加任何其他文字：

{
  "signal": "Long" | "Side" | "Short",
  "confidence": 0.0 ~ 1.0,
  "summary": "一句话核心结论（15字以内）",
  "reasoning_trace": [
    { "step": "trend", "data": "关键趋势数据", "conclusion": "趋势判断" },
    { "step": "momentum", "data": "动能指标数据", "conclusion": "动能判断" },
    { "step": "volume", "data": "量能数据", "conclusion": "量能判断" },
    { "step": "history", "data": "历史预测数据", "conclusion": "历史参考" },
    { "step": "decision", "data": "综合关键因素", "conclusion": "决策理由" }
  ],
  "tactics": {
    "holding": [...],   // 每项包含 priority, action, trigger, reason
    "empty": [...],
    "general": [...]
  },
  "key_levels": {
    "support": 数值,
    "resistance": 数值,
    "stop_loss": 数值
  },
  "conflict_resolution": "当指标冲突时的决策原则",
  "tomorrow_focus": "明日需重点关注的事项"
}
```

---

## 📊 JSON 数据结构定义

```typescript
/**
 * AI 决策核心数据包 (存储于 ai_predictions.ai_reasoning)
 */
export interface TacticalData {
    // 核心结论
    summary: string; 
    
    // 推理链（5步分析过程，用于三层体验展示）
    reasoning_trace: ReasoningStep[];

    // 结构化建议
    tactics: {
        holding: Tactic[]; // 持仓战术
        empty: Tactic[];   // 未建仓战术
        general: Tactic[]; // 通用战术（板块/公告等）
    };

    // 关键位（用于 UI 后期扩展显示）
    key_levels: {
        support: number;
        resistance: number;
        stop_loss: number;
    };

    // 决策逻辑
    conflict_resolution: string; // 冲突处理原则
    tomorrow_focus: string;      // 划重点
}

export interface ReasoningStep {
    step: 'trend' | 'momentum' | 'volume' | 'history' | 'decision';
    data: string;       // 关键数据点（≤20字）
    conclusion: string; // 判断结论（≤15字）
}

export interface Tactic {
    priority: "P1" | "P2" | "P3";
    action: string;  // 动作描述（如：止损/减仓）
    trigger: string; // 触发条件（如：跌破 15.80 且30分钟不收回）
    reason: string;  // 理由（如：防止趋势转盈为亏）
}
```

---

## 🔄 状态映射说明

- **Signal -> UI 颜色**: 
  - `Long`: 🟢 绿色 / 建议做多
  - `Side`: 🟡 黄色 / 建议观望
  - `Short`: 🔴 红色 / 建议避险
- **User Position -> Tactics 选择**:
  - `data.rule.position === 'holding'` -> 显示 `tactics.holding`
  - 其他情况 -> 显示 `tactics.empty`
  - `tactics.general` 始终作为附属补充显示。

---

## 🧠 上下文工程 (Context Engineering)

### 核心理念

> **给 LLM 更多的数据和信息 → LLM 给到的反馈就会更加精准**

这是一个正确的大方向，但需要加一些细微的限定条件：

**精准 ≠ 信息量多，精准 = 信息相关性高**

LLM 的上下文窗口有限。即使对于 Gemini 2.5 Pro 的 100万 tokens 窗口，越靠近 prompt 开头和结尾的信息，模型理解得越好，中间部分可能会"稀释"。所以，关键不是"堆数据"，而是：

| 维度                                | 说明                              |
| :---------------------------------- | :-------------------------------- |
| **Relevance（相关性）**             | 给的数据是否直接影响决策？        |
| **Structure（结构化）**             | 数据是以 LLM 友好的方式组织的吗？ |
| **Signal-to-Noise Ratio（信噪比）** | 关键信息是否突出？                |

---

### 当前 Prompt 的上下文结构

| 上下文层级        | 当前内容                           | 目的                |
| :---------------- | :--------------------------------- | :------------------ |
| **System Prompt** | 角色定义 + 核心原则 + 输出格式约束 | 约束 LLM 的行为边界 |
| **User Input**    | 股票基础信息 + 单日行情 + 技术指标 | 提供决策数据        |

---

### 待增强的上下文维度

| 缺失维度                 | 为什么重要                                                  | 示例                                      |
| :----------------------- | :---------------------------------------------------------- | :---------------------------------------- |
| **历史行情（多日）**     | 单日数据无法看出趋势，MA/MACD等指标已有，但原始趋势感知不足 | "过去 5 日连续收跌，累计跌幅 X%"          |
| **板块/大盘背景**        | 个股与大环境联动，盲区容易导致逆势判断                      | "恒生指数今日跌 2%，港股医药板块整体疲软" |
| **事件驱动 (News/公告)** | 技术面有时会被消息面覆盖                                    | "公司昨日公告：获 FDA 批准"               |
| **历史 AI 预测回顾**     | LLM 知道"自己之前说了什么"，可以形成连续性                  | "昨日 AI 建议做多，今日验证：✓ 涨 2%"     |
| **用户持仓状态**         | 设计理念就是区分 holding/empty，需传入实际状态              | "用户当前持仓成本：18.50"                 |

---

### 上下文工程的"黄金法则"

| 法则                          | 解释                                                                    |
| :---------------------------- | :---------------------------------------------------------------------- |
| **Just Enough Context**       | 不是越多越好，而是"刚刚好"。过多会分散注意力，过少会导致幻觉。          |
| **Structured > Unstructured** | 用表格、层级、JSON 比纯文本效果更好。                                   |
| **Instruction Clarity**       | 明确告诉 LLM "你需要做什么"，而不是"你可以做什么"。                     |
| **Example-Driven (Few-shot)** | 如果输出格式复杂，给几个示例会大幅降低格式错误率。                      |
| **Recency Bias 利用**         | 把最关键的指令放在 prompt 的结尾，因为 LLM 对"最后看到的内容"印象最深。 |

---

### 已实现的上下文维度 ✅

| #    | 维度                      | 实现方式                    | 效果                            |
| :--- | :------------------------ | :-------------------------- | :------------------------------ |
| 1    | **日线战术层 (Tactical)** | 10日明细 + 现时技术指标     | 捕捉短期买卖点、形态与动量      |
| 2    | **周线波段层 (Meso)**     | 8周明细 + 12周最高/最低统计 | 识别中期趋势、筑底/筑顶形态     |
| 3    | **月线战略层 (Macro)**    | 3个月明细 + 12个月高低总结  | 定义大周期海拔、牛熊分界线      |
| 4    | **板块联动与事件**        | 核心原则第5/6条             | 激活 LLM 内置知识与潜在搜索能力 |
| 5    | **AI 历史预测回顾**       | 近5次预测结果 + 全局准确率  | 建立自我反思机制，减少重复错误  |
| 6    | **Few-shot 示例**         | 完整的 JSON 输出示例        | 大幅降低格式错误率              |

---

### 完整 Prompt 结构

```
# 系统提示词 (System Prompt)
├── 角色定义
├── 6 条核心原则
│   ├── 1. 理性锚点（不预测涨跌）
│   ├── 2. 个性化（区分持仓/未建仓）
│   ├── 3. 可验证（建议可事后验证）
│   ├── 4. 简洁直白（降低理解门槛）
│   ├── 5. 板块联动（激活 LLM 内置知识）
│   └── 6. 事件驱动（尝试激活搜索能力）
├── 输出格式定义（JSON Schema）
└── 示例输出（Few-shot）

# 用户输入 (User Input)
├── 股票信息（名称、代码、日期）
├── 日线战术层（10日行情明细 + 现时技术指标）
├── 周线波段层（8周行情明细 + 12周价格极值）
├── 月线战略层（3个月行情明细 + 12个月行情极值 + 大周期水位定性）
├── AI 历史预测回顾（近5次结果 + 统计反思）
└── 操作请求
```

---

### 待探索的上下文维度

| 维度             | 说明                                | 复杂度 |
| :--------------- | :---------------------------------- | :----- |
| **用户持仓状态** | 传入用户的持仓成本，做更个性化建议  | 低     |
| **实时大盘数据** | 恒生指数/板块涨跌，需额外数据源     | 中     |
| **LLM 搜索增强** | 启用 Gemini Google Search Grounding | 中     |
| **多周期指标**   | 日线 + 周线数据联合分析             | 中     |

---

### 工具使用

使用 `generate_prompt_debug.py` 生成完整 Prompt：

```bash
cd backend
python generate_prompt_debug.py 02171
```

输出可直接复制到 Gemini / DeepSeek Chat 进行测试。
