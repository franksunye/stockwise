# StockWise AI 提示词及 JSON 结构设计

## 📌 项目初心

StockWise 的定位是 **“交易者的理性锚点”**。AI 的作用不是告诉用户股票一定会涨还是跌，而是基于当前的技术指标和用户持仓情况，提供一套**可执行、可验证**的纪律建议。

---

## 🎯 建议分类逻辑

我们将 AI 建议分为三种类型，以实现最大的个性化：

| 类型         | 标识符    | 适用场景                   | 核心价值                                   |
| :----------- | :-------- | :------------------------- | :----------------------------------------- |
| **持仓型**   | `holding` | 用户当前已持有该股票       | 关注止损位、加仓点，防止利润回吐或亏损扩。 |
| **未建仓型** | `empty`   | 用户正在观望，寻求入场机会 | 关注入场触发条件，识别“假突破”或弱势行情。 |
| **通用型**   | `general` | 适用于所有关注该标的的用户 | 关注行业板块动态、重大公告影响或大盘共振。 |

---

## 📝 LLM 提示词 (Prompt) 规范

### System Prompt (系统提示词)

```markdown
你是 StockWise 的 AI 决策助手，专门为个人投资者提供股票操作建议。

## 你的核心原则：
1. **理性锚点**：你不预测涨跌，你提供"执行纪律"的触发条件。
2. **个性化**：根据用户是"已持仓"还是"未建仓"，提供差异化的行动建议。
3. **可验证**：每条建议都有明确的触发条件，事后可验证对错。
4. **简洁直白**：使用普通人能秒懂的语言，避免晦涩术语。
5. **板块联动**：请结合你对该公司所属行业、板块特性及市场环境的理解，给出更有背景的建议。
6. **事件驱动**：如果你具备搜索能力，请尝试搜索该公司近期的重大新闻、公告或事件，并将其纳入分析（如无搜索能力可跳过此步）。

## 你的输出格式：
你必须严格按照以下 JSON 格式输出，不要添加任何其他文字：

{
  "signal": "Long" | "Side" | "Short",
  "confidence": 0.0 ~ 1.0,
  "summary": "一句话核心结论（15字以内）",
  "reasoning_trace": [
    { "step": "trend", "data": "关键趋势数据", "conclusion": "趋势判断" },
    { "step": "momentum", "data": "动能指标数据", "conclusion": "动能判断" },
    { "step": "volume", "data": "量能数据", "conclusion": "量能判断" },
    { "step": "history", "data": "历史预测数据", "conclusion": "历史参考" },
    { "step": "decision", "data": "综合关键因素", "conclusion": "决策理由" }
  ],
  "tactics": {
    "holding": [...],   // 每项包含 priority, action, trigger, reason
    "empty": [...],
    "general": [...]
  },
  "key_levels": {
    "support": 数值,
    "resistance": 数值,
    "stop_loss": 数值
  },
  "conflict_resolution": "当指标冲突时的决策原则",
  "tomorrow_focus": "明日需重点关注的事项"
}
```

---

## 📊 JSON 数据结构定义

```typescript
/**
 * AI 决策核心数据包 (存储于 ai_predictions.ai_reasoning)
 */
export interface TacticalData {
    // 核心结论
    summary: string; 
    
    // 推理链（5步分析过程，用于三层体验展示）
    reasoning_trace: ReasoningStep[];

    // 结构化建议
    tactics: {
        holding: Tactic[]; // 持仓战术
        empty: Tactic[];   // 未建仓战术
        general: Tactic[]; // 通用战术（板块/公告等）
    };

    // 关键位（用于 UI 后期扩展显示）
    key_levels: {
        support: number;
        resistance: number;
        stop_loss: number;
    };

    // 决策逻辑
    conflict_resolution: string; // 冲突处理原则
    tomorrow_focus: string;      // 划重点
}

export interface ReasoningStep {
    step: 'trend' | 'momentum' | 'volume' | 'history' | 'decision';
    data: string;       // 关键数据点（≤20字）
    conclusion: string; // 判断结论（≤15字）
}

export interface Tactic {
    priority: "P1" | "P2" | "P3";
    action: string;  // 动作描述（如：止损/减仓）
    trigger: string; // 触发条件（如：跌破 15.80 且30分钟不收回）
    reason: string;  // 理由（如：防止趋势转盈为亏）
}
```

---

## 🔄 状态映射说明

- **Signal -> UI 颜色**: 
  - `Long`: 🟢 绿色 / 建议做多
  - `Side`: 🟡 黄色 / 建议观望
  - `Short`: 🔴 红色 / 建议避险
- **User Position -> Tactics 选择**:
  - `data.rule.position === 'holding'` -> 显示 `tactics.holding`
  - 其他情况 -> 显示 `tactics.empty`
  - `tactics.general` 始终作为附属补充显示。

---

## 🧠 上下文工程 (Context Engineering)

### 核心理念

> **给 LLM 更多的数据和信息 → LLM 给到的反馈就会更加精准**

这是一个正确的大方向，但需要加一些细微的限定条件：

**精准 ≠ 信息量多，精准 = 信息相关性高**

LLM 的上下文窗口有限。即使对于 Gemini 2.5 Pro 的 100万 tokens 窗口，越靠近 prompt 开头和结尾的信息，模型理解得越好，中间部分可能会"稀释"。所以，关键不是"堆数据"，而是：

| 维度                                | 说明                              |
| :---------------------------------- | :-------------------------------- |
| **Relevance（相关性）**             | 给的数据是否直接影响决策？        |
| **Structure（结构化）**             | 数据是以 LLM 友好的方式组织的吗？ |
| **Signal-to-Noise Ratio（信噪比）** | 关键信息是否突出？                |

---

### 当前 Prompt 的上下文结构

| 上下文层级        | 当前内容                           | 目的                |
| :---------------- | :--------------------------------- | :------------------ |
| **System Prompt** | 角色定义 + 核心原则 + 输出格式约束 | 约束 LLM 的行为边界 |
| **User Input**    | 股票基础信息 + 单日行情 + 技术指标 | 提供决策数据        |

---

### 待增强的上下文维度

| 缺失维度                 | 为什么重要                                                  | 示例                                      |
| :----------------------- | :---------------------------------------------------------- | :---------------------------------------- |
| **历史行情（多日）**     | 单日数据无法看出趋势，MA/MACD等指标已有，但原始趋势感知不足 | "过去 5 日连续收跌，累计跌幅 X%"          |
| **板块/大盘背景**        | 个股与大环境联动，盲区容易导致逆势判断                      | "恒生指数今日跌 2%，港股医药板块整体疲软" |
| **事件驱动 (News/公告)** | 技术面有时会被消息面覆盖                                    | "公司昨日公告：获 FDA 批准"               |
| **历史 AI 预测回顾**     | LLM 知道"自己之前说了什么"，可以形成连续性                  | "昨日 AI 建议做多，今日验证：✓ 涨 2%"     |
| **用户持仓状态**         | 设计理念就是区分 holding/empty，需传入实际状态              | "用户当前持仓成本：18.50"                 |

---

### 上下文工程的"黄金法则"

| 法则                          | 解释                                                                    |
| :---------------------------- | :---------------------------------------------------------------------- |
| **Just Enough Context**       | 不是越多越好，而是"刚刚好"。过多会分散注意力，过少会导致幻觉。          |
| **Structured > Unstructured** | 用表格、层级、JSON 比纯文本效果更好。                                   |
| **Instruction Clarity**       | 明确告诉 LLM "你需要做什么"，而不是"你可以做什么"。                     |
| **Example-Driven (Few-shot)** | 如果输出格式复杂，给几个示例会大幅降低格式错误率。                      |
| **Recency Bias 利用**         | 把最关键的指令放在 prompt 的结尾，因为 LLM 对"最后看到的内容"印象最深。 |

---

### 已实现的上下文维度 ✅

| #    | 维度                      | 实现方式                    | 效果                            |
| :--- | :------------------------ | :-------------------------- | :------------------------------ |
| 1    | **日线战术层 (Tactical)** | 10日明细 + 现时技术指标     | 捕捉短期买卖点、形态与动量      |
| 2    | **周线波段层 (Meso)**     | 8周明细 + 12周最高/最低统计 | 识别中期趋势、筑底/筑顶形态     |
| 3    | **月线战略层 (Macro)**    | 3个月明细 + 12个月高低总结  | 定义大周期海拔、牛熊分界线      |
| 4    | **板块联动与事件**        | 核心原则第5/6条             | 激活 LLM 内置知识与潜在搜索能力 |
| 5    | **AI 历史预测回顾**       | 近5次预测结果 + 全局准确率  | 建立自我反思机制，减少重复错误  |
| 6    | **Few-shot 示例**         | 完整的 JSON 输出示例        | 大幅降低格式错误率              |

---

### 完整 Prompt 结构

```
# 系统提示词 (System Prompt)
├── 角色定义
├── 6 条核心原则
│   ├── 1. 理性锚点（不预测涨跌）
│   ├── 2. 个性化（区分持仓/未建仓）
│   ├── 3. 可验证（建议可事后验证）
│   ├── 4. 简洁直白（降低理解门槛）
│   ├── 5. 板块联动（激活 LLM 内置知识）
│   └── 6. 事件驱动（尝试激活搜索能力）
├── 输出格式定义（JSON Schema）
└── 示例输出（Few-shot）

# 用户输入 (User Input)
├── 股票信息（名称、代码、日期）
├── 日线战术层（10日行情明细 + 现时技术指标）
├── 周线波段层（8周行情明细 + 12周价格极值）
├── 月线战略层（3个月行情明细 + 12个月行情极值 + 大周期水位定性）
├── AI 历史预测回顾（近5次结果 + 统计反思）
└── 操作请求
```

---

## 架构演进：多 Agent 协同上下文 (Proposed)

为了解决随着上下文增加导致的**注意力分散 (Attention Dilution)** 和 **Token 拥挤** 问题，我们计划在未来将单体 Prompt 升级为 **垂直分工的多 Agent 系统 (Vertical Specialization)**。

### 设计理念
将复杂的决策过程拆解为独立且专业的子任务，最后由主 Agent 汇总决策。

![Multi-Agent Architecture](https://via.placeholder.com/800x400?text=Traceability+Strategy)

### Agent 角色分工

1.  **📊 技术分析 Agent (Technical Analyst)**
    *   **职责**: 仅关注 K 线形态、均线系统、成交量分布。
    *   **输入**: OHLCV 数据、技术指标 (RSI/MACD)。
    *   **输出**: 纯技术面的“形态语言”（如：“底背离确认”、“量价配合完美”）。
    *   **优势**: 排除情绪干扰，通过数学逻辑输出客观信号。

2.  **📰 消息洞察 Agent (News Insight)**
    *   **职责**: 仅关注文本数据，进行情感分析和关键事件提取。
    *   **输入**: 新闻标题、公告摘要、研报观点。
    *   **输出**: 结构化的“利好/利空因子”（如：“因子：立案调查 | 强度：高 | 方向：空”）。
    *   **优势**: 擅长处理非结构化长文本，不受 K 线波动影响。

3.  **🧠 主决策 Agent (Lead Decision Maker)**
    *   **职责**: 扮演基金经理角色，接收上述两个 Agent 的精炼汇报。
    *   **输入**: 技术结论 + 消息因子 + 用户持仓数据。
    *   **输出**: 最终 JSON 格式的操作建议 (Tactics) 和置信度。
    *   **优势**: 解决“幻觉”问题，当技术面与基本面冲突时（如：形态好但有暴雷风险），能够依据预设权重进行**冲突裁决 (Conflict Resolution)**。

### 实施路线
*   **阶段一 (当前)**: **Virtual Agents (伪 Agent)**。在 System Prompt 中通过 `Role Playing` 和 `Chain of Thought` 模拟分工，无需改变代码架构。
*   **阶段二 (未来)**: **Physical Agents (真 Agent)**。使用 `asyncio` 并行调用多个专门优化的 LLM 实例（或不同模型），实现真正的解耦与并发处理。

---

### 待探索与优化的上下文维度 (Roadmap)

为了进一步提升 AI 的“决策质量”而非仅仅是“预测准确度”，我们需要利用 AkShare 的深度数据能力，完成以下上下文维度的拼图：

| 维度               | 实现策略 (基于 AkShare)                                         | 优化目的                                                 | 优先级 | 状态               |
| :----------------- | :-------------------------------------------------------------- | :------------------------------------------------------- | :----- | :----------------- |
| **公司基本面概况** | 接口 `stock_profile_cninfo`                                     | 建立 AI 对个股的“第一印象”，理解其赚钱逻辑。             | **P0** | ✅ 已上线           |
| **分红与停复牌**   | 接口 `stock_fhps_detail_em` & `news_trade_notify_suspend_baidu` | 自动识别“非交易因素”导致的价格缺口，预警除权除息及停牌。 | **P1** | ✅ 已验证 (稳定)    |
| **即时消息面感知** | 接口 `stock_news_em`                                            | 识别突发利好/利空。                                      | **P1** | ❌ 不稳定 (Blocked) |
| **重大公告提醒**   | 接口 `stock_notice_report`                                      | 捕捉影响股价中长期走势的确定性事件。                     | **P1** | ⚠️ 无个股接口       |
| **北水/机构持仓**  | 接口 `stock_hsgt_individual_em` (参数: symbol)                  | 识别股票背后的底气。                                     | **P2** | ✅ 已验证 (稳定)    |
| **主力/游资动向**  | 接口 `stock_lhb_stock_statistic_em` (参数: "近一月")            | 捕捉大资金进出痕迹。                                     | **P2** | ✅ 已验证 (需过滤)  |
| **板块背景共振**   | 接口 `stock_board_industry_index_em`                            | 判断个股是“独秀”还是“陪跑”。                             | **P3** | 🟢 可行 (需映射)    |

---

### 上下文工程的“进阶落地策略”

1.  **静态上下文 (Static Context) - P0 级落地**：
    - **实现方式**：在 `stock_meta` 表中新增 `profile` 字段，定期同步 `stock_profile_cninfo` 数据。
    - **Prompt 入法**：`[公司概况]: 该公司是 A 股领先的存储芯片设计商，主营业务占比 80% 为 DRAM 芯片。`
    - **价值**：让 AI 知道它在分析谁。

2.  **动态事件 (Dynamic Events) - P1 级落地**：
    - **实现方式**：ETL 运行时调用 `stock_news_em` 抓取当日头条。
    - **Prompt 入法**：`[今日要闻]: 1. 公司宣布拟 10 亿元回购注销股份；2. 某大股东减持 2% 股份计划到期。`
    - **价值**：解释技术指标无法说明的“异动”。

3.  **资金流向 (Capital Flow) - P2 级落地**：
    - **实现方式**：整合龙虎榜与大宗交易数据。
    - **Prompt 入法**：`[主力分布]: 今日上榜龙虎榜，三家机构买入合计 1.2 亿，疑似知名游资“宁波敢死队”席位。`
    - **价值**：从静态指标转向动态博弈。

---

### 上下文工程的“进阶策略”

1.  **滑动窗口 (Sliding Window) 优化**：
    - 不再仅仅传入近 10 日数据，而是根据波动率动态调整窗口。
    - 关键拐点（如 20 日均线得失、半年线纠缠）需要以“标记位”的形式明确标注，而非让 LLM 自己推算。

2.  **多 Agent 协同上下文 (Proposed)**：
    - **技术分析 Agent**：只负责将指标翻译成“形态语言”。
    - **消息洞察 Agent**：只负责从新闻中提取“利好/利空因子”。
    - **主决策 Agent**：接收上述结构化上下文，输出最终 JSON。

3.  **负向约束嵌入**：
    - 在 Prompt 中明确告知 LLM 哪些是“不可预测的数据”（如无量上涨的仙股），强制要求 AI 在这类场景下降低 `confidence` 并给出 `Side` (观望) 建议。

---

## 📋 提示词审计与优化方向 (Audit & Optimization)

> **审计日期**: 2026-01-06  
> **审计对象**: `backend/engine/prompts.py`

### ✅ 优势 (Strengths)

| 维度                  | 优点                                                                                                             |
| :-------------------- | :--------------------------------------------------------------------------------------------------------------- |
| **数据丰富度**        | 多周期（日/周/月）数据齐全，包含 Price Action、技术指标、历史预测回顾，为 LLM 提供了充分的决策依据。             |
| **结构化输入**        | 使用 Markdown 表格呈现历史数据，可读性极高，LLM 能够轻松解析。                                                   |
| **One-Shot 示例完整** | 7 步推理链（Trend → Momentum → Volume → Level → Fundamentals → News → Decision）覆盖全维度，是优秀的"行为锚定"。 |
| **动态上下文指令**    | `context_instruction` 根据 `as_of_date` 动态切换"回填模式/实时模式"，逻辑严谨，避免了"模拟日期"困惑。            |
| **保守倾向约束**      | "宁缺勿滥"原则 + 80% 胜率门槛 + 拒识机制，有效抑制 LLM 过度自信出 Long/Short。                                   |
| **JSON 强约束收尾**   | 末尾的 `IMPORTANT OUTPUT RULE` 用英文强调纯 JSON，利用了 LLM 的"近因效应 (Recency Bias)"。                       |
| **历史预测反馈闭环**  | 将 AI 自己过去的预测及验证结果回传，形成"反思学习"，有助于提升一致性。                                           |

---

### ⚠️ 不足与潜在风险 (Weaknesses / Risks)

| 维度                       | 问题                                                                                                           | 潜在影响                                                                     |
| :------------------------- | :------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------- |
| **示例信号单一**           | One-Shot 示例只展示了 `"signal": "Side"` 的场景。LLM 可能缺乏"如何输出 Long/Short"的范例锚定。                 | 模型可能过度输出 Side，即使是明显的多头/空头机会也不敢给出明确信号。         |
| **news_analysis 依赖联网** | 提示词鼓励 LLM 搜索新闻，但无法保证 LLM 具备联网能力（取决于部署环境）。                                       | 若 LLM 无法联网，它可能编造新闻（幻觉），或干脆留空。需要 fallback 逻辑。    |
| **tactics 结构复杂**       | 三层嵌套（holding/empty/general → priority/action/trigger/reason）对 LLM 来说认知负担较重。                    | 增加了 JSON 截断或字段缺失的风险，尤其在 Gemini Flash 这种"速度优先"模型上。 |
| **缺乏"错误示例"负约束**   | 只有"正确格式"的正例，没有"错误格式"的反例（如带 Markdown 的 JSON）。                                          | LLM 可能不知道哪些行为是禁止的，仅靠正例锚定不够健壮。                       |
| **Profile 截断风险**       | `desc[:100]` 硬截断公司简介，可能在中文语境下截断在非语义边界。                                                | 可能产生半句话，轻微影响 LLM 理解。                                          |
| **Token 消耗较高**         | 完整 Prompt（System + User）预估约 2500-3000 tokens。若 LLM 输出截断与 context window 竞争相关，这可能是隐患。 | 在 8K 输出窗口的模型上，长 Prompt 可能挤压输出空间。                         |
| **中英混杂**               | 系统指令用中文，末尾 `IMPORTANT OUTPUT RULE` 用英文。理论上应统一语言锚定。                                    | 轻微，但可能让模型产生"双语切换"的认知负担。                                 |
| **缺乏 Schema 强校验**     | 没有使用 Gemini 的 `response_schema` / `response_mime_type` 参数进行结构化输出约束。                           | 仅靠"软约束"（提示词）控制格式，不如"硬约束"（API 层 schema）可靠。          |

---

### 💡 改进方向建议 (Optimization Roadmap)

以下为待讨论的优化方向，不立即修改：

| #    | 优化项                   | 描述                                                                                                                | 优先级 | 状态     |
| :--- | :----------------------- | :------------------------------------------------------------------------------------------------------------------ | :----- | :------- |
| 1    | **增加 Long/Short 示例** | 再提供一个 `"signal": "Long"` 的完整 One-Shot，让 LLM 知道"大行情来了敢出手"。                                      | P1     | 🟡 待讨论 |
| 2    | **添加负约束示例**       | 明确说明"以下格式是错误的：\`\`\`json {...}\`\`\`"，防止 LLM 输出带 Markdown 标记的 JSON。                          | P1     | 🟡 待讨论 |
| 3    | **简化 tactics 结构**    | 考虑扁平化为数组，或减少必填字段，降低 LLM 认知负担和 JSON 截断风险。                                               | P2     | 🟡 待讨论 |
| 4    | **无联网时的 fallback**  | 添加指令"如果无法搜索新闻，请在 `news_analysis` 中注明'无法获取实时新闻'"，而非留空或编造。                         | P1     | 🟡 待讨论 |
| 5    | **利用 API 层 Schema**   | 如果 LLM Provider 支持（如 Vertex AI 的 Gemini），启用 `response_mime_type: application/json` + `response_schema`。 | P2     | 🟡 待讨论 |
| 6    | **智能截断公司简介**     | 将 `desc[:100]` 改为按句子边界截断，避免产生半句话。                                                                | P3     | 🟡 待讨论 |
| 7    | **统一 Prompt 语言**     | 将末尾的英文约束改为中文，或将整体 Prompt 统一为英文，减少双语切换负担。                                            | P3     | 🟡 待讨论 |

---

### 📊 当前评估结论

> **总体评价**: 这是一份 **工程质量相当高** 的提示词，结构清晰、数据丰富、约束明确。  
> **主要风险**: "示例偏向单一信号"和"对联网能力的隐式假设"。  
> **当前状态**: 在 Gemini 3 Flash + 重试机制的组合下已能稳定运行，上述改进可进一步提升鲁棒性和输出多样性。

---

### 工具使用

使用 `generate_prompt_debug.py` 生成完整 Prompt：

```bash
cd backend
python generate_prompt_debug.py 02171
```

输出可直接复制到 Gemini / DeepSeek Chat 进行测试。

---

## 📰 每日简报 (Daily Brief) 提示词设计

> **模块位置**: `backend/engine/brief_generator.py`  
> **角色定位**: **The Reporter (记者)** - 遵循 `Reliability_Protocol.md` 的职能隔离原则

### 设计理念

根据 `Reliability_Protocol.md`：
> **The Reporter (记者)** 的唯一任务是把 Analyst 的结论翻译成"人话"。它**不被允许做分析**。

简报生成器的 LLM 调用是一个"格式转换"过程，而非"智能分析"过程。我们必须确保：
1.  **所有观点 100% 继承自数据库** (Signal, ai_reasoning)
2.  **所有事实必须可溯源** (价格、RSI、支撑位等来自 `daily_prices` / `ai_predictions_v2`)
3.  **新闻仅作背景** (Tavily 返回的内容仅供 LLM 翻译，不用于生成新观点)

---

### 数据锚定 (Data Grounding) 清单

#### 🔴 当前已传入的数据 (Before Audit)

| 数据项       | 来源                | 问题                                |
| ------------ | ------------------- | ----------------------------------- |
| `signal`     | `ai_predictions_v2` | ⚠️ 查询字段错误 (date → target_date) |
| `confidence` | `ai_predictions_v2` | ⚠️ 同上                              |
| `rsi`        | **硬编码 50**       | ❌ Mock 数据                         |
| `news`       | Tavily API          | ✅ 正常                              |

#### 🟢 应当传入的完整数据 (After Optimization)

| 数据项            | 来源表              | 字段                                 | Prompt 中的作用                   |
| ----------------- | ------------------- | ------------------------------------ | --------------------------------- |
| **信号**          | `ai_predictions_v2` | `signal` (target_date, is_primary=1) | 核心结论锚定                      |
| **置信度**        | `ai_predictions_v2` | `confidence`                         | 表达强度                          |
| **AI 原始推理**   | `ai_predictions_v2` | `ai_reasoning`                       | ⭐ **最重要**: Reporter 翻译的素材 |
| **支撑/压力位**   | `ai_predictions_v2` | `support_price`, `pressure_price`    | 关键价位提示                      |
| **收盘价/涨跌幅** | `daily_prices`      | `close`, `change_percent`            | 行情事实                          |
| **RSI**           | `daily_prices`      | `rsi`                                | 技术面背书                        |
| **MACD**          | `daily_prices`      | `macd`, `macd_signal`                | 技术面背书                        |
| **KDJ**           | `daily_prices`      | `kdj_k`, `kdj_d`, `kdj_j`            | 超买超卖状态                      |
| **新闻摘要**      | Tavily API          | 搜索结果                             | 消息面背景                        |

---

### 优化后的 Prompt 结构

```
# System Prompt
你是一位资深财经记者，正在为中国投资者撰写股票每日简报。
你的任务是将"分析师报告"翻译成简洁、专业的中文摘要。

## 核心原则：
1. **不做分析**: 你不产生新观点，只翻译和总结已有的"分析师结论"。
2. **事实锚定**: 每一个数字必须来自"硬数据"部分，禁止虚构。
3. **简洁专业**: 投资者时间宝贵，用最少的文字传达最多的信息。

# User Input
Subject: 00700 (腾讯控股)

[硬数据 - 来自数据库，禁止虚构]
- 今日收盘: 412.60 HKD (+1.25%)
- AI 信号: Long (置信度 70%)
- 支撑位: 400.00 | 压力位: 425.00
- RSI: 52.3 | KDJ: K=45/D=42/J=51 | MACD: 看涨背离中

[分析师推理 - 来自 AI Analyst，你只需翻译]
{ai_reasoning 原文}

[今日新闻 - 来自 Tavily，提供背景]
- **标题1**: 正文摘要...
- **标题2**: 正文摘要...

任务: 输出中文每日简报。结构如下：
1. **综合分析** (一段话，~50字)
2. **关键新闻** (1-2条中文要点)
```

---

### 实施计划

| 步骤 | 修改内容                                    | 优先级   |
| ---- | ------------------------------------------- | -------- |
| 1    | 修复 `target_date` 查询 + `is_primary` 过滤 | ✅ 已完成 |
| 2    | 从 `daily_prices` 获取真实 RSI              | ✅ 已完成 |
| 3    | 传入 `ai_reasoning` (Analyst 原始推理)      | 🔜 下一步 |
| 4    | 传入 `close`, `change_percent`              | 🔜 下一步 |
| 5    | 传入 `support_price`, `pressure_price`      | 🔜 下一步 |
| 6    | 传入 KDJ/MACD 关键指标                      | 🔜 下一步 |
| 7    | 更新 System Prompt 强化"不做分析"约束       | 🔜 下一步 |

---

### 验证标准

1.  **Signal 正确性**: push_hook 中的"看涨/看跌"数量必须与 `ai_predictions_v2.signal` 一致。
2.  **RSI 真实性**: 简报中出现的 RSI 值必须与 `daily_prices.rsi` 匹配。
3.  **无幻觉**: 简报中不应出现 `ai_reasoning` 或 `news` 中未提及的公司事件。
