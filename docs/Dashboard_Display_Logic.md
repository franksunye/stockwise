# Dashboard 显示逻辑规格

> 版本: 2.0  
> 创建时间: 2025-12-26  
> 最后更新: 2025-12-29  
> 状态: 已确认

---

## 一、核心原则

**数据驱动的一致性**：所有显示信息（标题、内容、验证、价格）必须逻辑自洽，避免让用户产生困惑。

### 设计哲学

1.  **所见即所得**：标题说"今日建议"，内容就是"今日"的；标题说"验证"，就是验证当前显示的预测。
2.  **优雅降级**：当后端数据滞后或错误时，前端应通过视觉警告告知用户，而不是展示错误信息。
3.  **用户视角时间**："明天"虽然物理上存在，但在周日晚上用户心里，"下周一"才是"明天"。

---

## 二、时间场景与数据映射

基于交易市场（HK/CN）的**下一个交易日**计算。

| 场景            | 定义         | 标题示例     | 预测数据来源             | 验证区显示             |
| :-------------- | :----------- | :----------- | :----------------------- | :--------------------- |
| **交易中 (S1)** | 开盘 ~ 收盘  | `今日建议`   | `target_date` = 今天     | `待收盘验证`           |
| **收市后 (S2)** | 收盘 ~ 24:00 | `明日建议`   | `target_date` = 次交易日 | `今日验证` (准确/偏差) |
| **周末/假期**   | 非交易日     | `下周一建议` | `target_date` = 次交易日 | `周五验证` (准确/偏差) |

> **关键规则**：
>
> *   **周末特殊处理**：如果次交易日是周一，周六/日显示 `下周一建议`，避免歧义。
> *   **长假期处理**：显示具体日期，如 `1/29 建议`。
> *   **A股/港股差异**：需根据股票代码自动区分市场假期（如端午节A股休市港股开市）。

---

## 三、异常处理与优雅降级

当后端数据同步失败或滞后时（如本地开发环境），前端必须进行**新鲜度检测**。

### 3.1 新鲜度检测逻辑

```typescript
const isDataStale = (scene === 'trading' || isPreMarket) 
  && !todayPrediction; // 没有找到 target_date = 今天的预测
```

### 3.2 降级显示

当检测到数据过时（`isDataStale === true`）：

1.  **标题降级**：不再显示 `今日建议`，而是显示实际日期（如 `12/25 建议`）。
2.  **视觉警告**：在标题旁显示黄色圆点与 `数据待同步` 提示。
3.  **内容保留**：显示最近一次可用的预测，供用户参考。

---

## 四、数据与验证的一致性

为避免逻辑分裂，遵循以下单一数据源原则：

1.  **预测源**：先根据场景和日期找到唯一的 `displayPrediction`。
2.  **信号展示**：展示 `displayPrediction.signal`。
3.  **验证展示**：展示 `displayPrediction.validation_status`。

**禁止**：分别计算预测和验证（例如：顶部显示明日预测，底部显示昨日验证），必须是同一条记录的一体两面。

---

## 五、后端配套逻辑

1.  **盘中同步 (Realtime Sync)**：
    *   ✅ 仅更新 `price`, `rsi` 等指标。
    *   ❌ **严禁**生成新的 AI 预测（AI 预测仅在收盘后全量数据下生成）。
    *   ❌ **严禁**执行验证（验证需要确定的收盘价）。
2.  **全量同步 (Daily Sync)**：
    *   ✅ 验证昨日预测（使用确定的收盘价）。
    *   ✅ 生成明日预测。

---

## 六、待办检查清单

*   [x] 修复：后端盘中同步不生成预测
*   [x] 修复：后端正确处理假期（A股/港股日历）
*   [x] 修复：前端 `target_date` 匹配逻辑
*   [x] 新增：前端数据新鲜度检测与降级 UI
*   [ ] 监控：观察长假期（如春节）期间的显示是否符合预期
