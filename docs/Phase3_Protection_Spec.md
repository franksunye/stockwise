# 第3阶段功能规格书：护城河 (保护与日志)

## 目标
构建能够留住用户的"护城河"，成为用户的**行为教练 (Behavioral Coach)**。
从"预测" (第1/2阶段) 转向"保护" (第3阶段)。
**核心价值**：**"一个主动的合伙人，在您犯傻前阻止您。"**

---

## 功能 1：冲动交易阻断器 (The Impulse Guard)
**"交易的安全带"**

### 概念
一个实时的干预系统，用于在盘中检测潜在的冲动行为，并引入"良性摩擦"。

### 触发条件
1.  **计划外标的**：用户在盘中搜索/点击一只与其"晚间日报" / "自选股"无关的*新*股票。
2.  **高波动性**：目标股票价格波动剧烈（如 5分钟内涨跌幅 >3%）。
3.  **追高行为**：价格接近当日最高点。

### 用户体验流程 (UX Flow)
1.  **干预**：不直接显示个股详情，而是弹出一个半透明的**"风险检查"层 (Risk Check Overlay)**。
    *   *文案*："⚠️ 等一等。这只股票**不在**您的昨夜计划中。您是在追高吗？"
    *   *操作*：[解锁 (5秒倒计时)] 或 [运行快速分析]。
2.  **快速分析 (Mini-Brief)**：
    *   AI 快速检查："RSI 达 85 (严重超买)。AI 信号为中性。历史上追高此类形态的成功率仅为 20%。"
    *   *按钮*："我仍想交易" (系统将此决策记录在案)。

### 技术需求
- **实时状态**：前端需要区分"交易时间"与"复盘时间"。
- **计划上下文**：对比 `当前访问股票` vs `用户今日计划列表`。
- **极速数据**：需要在 1秒内获取实时行情 (价格, RSI)。

---

## 功能 2：AI 交易诊断 (AI Trade Diagnostics)
**"智能魔镜"**

### 概念
一个无痛的"交易日志"，AI 充当阅卷老师。

### 输入机制 (低摩擦)
- **自然语言**：用户输入 "380买入腾讯"。
- **截图上传**：用户上传券商成交截图。

### AI 分析输出
1.  **计划执行度 (Plan Compliance)**："您是否遵循了昨夜计划？"
    *   *计划*：支撑位 375 买入。 *实际*：380 追入。
    *   *判定*："偏离计划。因 FOMO (错失恐惧) 您多支付了 1.3% 的溢价。"
2.  **环境检查**："在您买入的那一刻 (10:30 AM)，板块整体正在下跌。"
3.  **行为打标**：自动将该笔交易标记为 `#冲动交易` 或 `#纪律执行` 或 `#报复性交易`。

### 价值闭环 (Value Loop)
- **周报**："您本周亏损 $500。其中 $400 来自 `#冲动交易`。如果您严格执行计划，您本应盈利 $100。" -> **实打实的价值证据**。

---

## 功能 3：组合健康度 (Portfolio Health)
**"安睡雷达"**

### 概念
检测单只股票分析所遗漏的风险（主要是相关性和集中度风险）。

### 核心指标 (简单且可行动)
1.  **相关性风险**："风险警示！您持有的 3 只股票 (腾讯, 美团, 阿里) 同涨同跌。如果科技股崩盘，您的资产将承压 3 倍。"
2.  **波动率负荷**："您的组合波动率是恒生指数的 2 倍。您能承受今天 5% 的回撤吗？"
3.  **行业集中度**："90% 的仓位集中在科技板块。"

### UI 可视化
- **"护盾"图**：一个雷达图。完整的护盾 = 保护良好。破碎的护盾 = 存在漏洞。

---

## 实施路线图 (Phase 3)

### 步骤 1：构建"日志"数据结构
- 创建 `trade_journal` 表 (字段：user_id, symbol, action, price, timestamp, reason, adherence_to_plan)。
- 开发交易记录 API (支持文本/结构化输入)。

### 步骤 2：前端"阻断器"逻辑
- 修改 `StockProfile` 组件，增加 `is_in_plan` (是否在计划内) 的检查逻辑。
- 开发 "干预弹窗 (Intervention Modal)" 组件。

### 步骤 3："教练"分析引擎
- 后端定时任务：将 `trade_journal` 条目与 `stock_briefs` (历史计划) 进行对比分析。
- 生成 "教练反馈" 文案。
