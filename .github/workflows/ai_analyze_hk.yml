name: AI Analysis - Hong Kong (HK)

# 职责：仅负责港股 AI 分析，不包含数据同步

on:
  workflow_dispatch: # 支持手动触发
    inputs:
      force:
        description: 'Force re-analysis (overwrite existing)'
        type: boolean
        required: false
        default: false
  workflow_call:     # 支持被其他 workflow 调用
    inputs:
      force:
        description: 'Force re-analysis'
        type: boolean
        required: false
        default: false

jobs:
  analyze-hk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run AI Analysis for Hong Kong
        env:
          PYTHONUNBUFFERED: "1"
          # 数据库
          TURSO_DB_URL: ${{ secrets.TURSO_DB_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          # AI 服务
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
          LLM_ENABLED: ${{ secrets.LLM_ENABLED }}
          LLM_PROVIDER: deepseek
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
          HUNYUAN_API_KEY: ${{ secrets.HUNYUAN_API_KEY }}
          # 通知
          WECOM_ROBOT_KEY: ${{ secrets.WECOM_ROBOT_KEY }}
          INTERNAL_API_SECRET: ${{ secrets.INTERNAL_API_SECRET }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
        run: |
          FORCE_FLAG=""
          if [ "${{ inputs.force }}" == "true" ]; then
            FORCE_FLAG="--force"
          fi
          python -u backend/main.py --analyze --market HK --model all $FORCE_FLAG
