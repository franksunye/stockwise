name: AI Analysis - Hong Kong (HK)

# èŒè´£ï¼šä»…è´Ÿè´£æ¸¯è‚¡ AI åˆ†æï¼Œä¸åŒ…å«æ•°æ®åŒæ­¥

on:
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      force:
        description: 'Force re-analysis (overwrite existing)'
        type: boolean
        required: false
        default: false
      date:
        description: 'Specify date (YYYY-MM-DD)'
        type: string
        required: false
        default: ''
  workflow_call:     # æ”¯æŒè¢«å…¶ä»– workflow è°ƒç”¨
    inputs:
      force:
        description: 'Force re-analysis'
        type: boolean
        required: false
        default: false
      date:
        description: 'Specify date'
        type: string
        required: false
        default: ''

jobs:
  analyze-hk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run AI Analysis for Hong Kong
        env:
          PYTHONUNBUFFERED: "1"
          # æ•°æ®åº“
          TURSO_DB_URL: ${{ secrets.TURSO_DB_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          # AI æœåŠ¡
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
          LLM_ENABLED: ${{ secrets.LLM_ENABLED }}
          LLM_PROVIDER: deepseek
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_BASE_URL: ${{ secrets.DEEPSEEK_BASE_URL }}
          HUNYUAN_API_KEY: ${{ secrets.HUNYUAN_API_KEY }}
          # é€šçŸ¥
          WECOM_ROBOT_KEY: ${{ secrets.WECOM_ROBOT_KEY }}
          INTERNAL_API_SECRET: ${{ secrets.INTERNAL_API_SECRET }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
        run: |
          FORCE_FLAG=""
          if [ "${{ inputs.force }}" == "true" ]; then
            FORCE_FLAG="--force"
            echo "âš ï¸ Force mode enabled via input."
          else
            echo "â„¹ï¸ Force mode disabled."
          fi

          DATE_FLAG=""
          if [ -n "${{ inputs.date }}" ]; then
            DATE_FLAG="--date ${{ inputs.date }}"
            echo "ğŸ“… Target date set to: ${{ inputs.date }}"
          fi

          echo "ğŸš€ Executing: python -u backend/main.py --analyze --market HK --model all $FORCE_FLAG $DATE_FLAG"
          python -u backend/main.py --analyze --market HK --model all $FORCE_FLAG $DATE_FLAG
