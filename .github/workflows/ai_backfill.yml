name: AI Analysis - Backfill

# 职责：补跑历史 AI 分析

on:
  workflow_dispatch:
    inputs:
      market:
        description: '市场 (留空则全部)'
        required: false
        type: choice
        options:
          - ''
          - CN
          - HK
      symbol:
        description: '股票代码 (留空则全部)'
        required: false
        type: string
      mode:
        description: '回填模式'
        required: true
        type: choice
        options:
          - auto-fill   # 智能检测缺失
          - single-date # 单日
          - date-range  # 日期范围
          - recent-days # 最近N天
      date:
        description: '单日模式: 日期 (YYYY-MM-DD)'
        required: false
        type: string
      start_date:
        description: '范围模式: 开始日期 (YYYY-MM-DD)'
        required: false
        type: string
      end_date:
        description: '范围模式: 结束日期 (YYYY-MM-DD)'
        required: false
        type: string
      days:
        description: '最近N天模式: 天数'
        required: false
        type: string
        default: '7'

jobs:
  backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run AI Backfill
        env:
          PYTHONUNBUFFERED: "1"
          # 数据库
          TURSO_DB_URL: ${{ secrets.TURSO_DB_URL }}
          TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
          # AI 服务
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
          LLM_ENABLED: ${{ secrets.LLM_ENABLED }}
          LLM_PROVIDER: deepseek
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          # 通知
          WECOM_ROBOT_KEY: ${{ secrets.WECOM_ROBOT_KEY }}
        run: |
          # 构建命令参数
          CMD="python -u backend/main.py --analyze"
          
          # 市场过滤
          if [ -n "${{ inputs.market }}" ]; then
            CMD="$CMD --market ${{ inputs.market }}"
          fi
          
          # 股票代码
          if [ -n "${{ inputs.symbol }}" ]; then
            CMD="$CMD --symbol ${{ inputs.symbol }}"
          fi
          
          # 回填模式
          case "${{ inputs.mode }}" in
            auto-fill)
              CMD="$CMD --auto-fill"
              ;;
            single-date)
              CMD="$CMD --date ${{ inputs.date }}"
              ;;
            date-range)
              CMD="$CMD --start-date ${{ inputs.start_date }} --end-date ${{ inputs.end_date }}"
              ;;
            recent-days)
              CMD="$CMD --days ${{ inputs.days }}"
              ;;
          esac
          
          echo "执行命令: $CMD"
          $CMD
