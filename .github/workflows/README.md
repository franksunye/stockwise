# StockWise GitHub Workflows è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç°çŠ¶åˆ†æ

### å½“å‰ Workflows æ¸…å•

| æ–‡ä»¶                     | è§¦å‘æ–¹å¼         | åŠŸèƒ½            | é—®é¢˜                    |
| ------------------------ | ---------------- | --------------- | ----------------------- |
| `daily_sync.yml`         | æ‰‹åŠ¨             | å…¨é‡åŒæ­¥+AIåˆ†æ | âš ï¸ å·²åºŸå¼ƒï¼Œä¸ CN/HK é‡å¤ |
| `daily_sync_cn.yml`      | å®šæ—¶ (UTC 8:00)  | Aè‚¡æ•°æ®+AIåˆ†æ  | ğŸ”´ æ•°æ®åŒæ­¥å’ŒAIåˆ†æè€¦åˆ  |
| `daily_sync_hk.yml`      | å®šæ—¶ (UTC 8:30)  | æ¸¯è‚¡æ•°æ®+AIåˆ†æ | ğŸ”´ æ•°æ®åŒæ­¥å’ŒAIåˆ†æè€¦åˆ  |
| `realtime-sync.yml`      | æ‰‹åŠ¨/Worker      | ç›˜ä¸­å®æ—¶åŒæ­¥    | âœ… èŒè´£å•ä¸€              |
| `metadata_sync.yml`      | å®šæ—¶ (UTC 22:00) | å…ƒæ•°æ®åŒæ­¥      | âœ… èŒè´£å•ä¸€              |
| `on-demand-sync.yml`     | æ‰‹åŠ¨             | å•è‚¡ç¥¨åŒæ­¥      | âœ… èŒè´£å•ä¸€              |
| `admin_manage_codes.yml` | æ‰‹åŠ¨             | é‚€è¯·ç ç®¡ç†      | âœ… èŒè´£å•ä¸€              |

### ä¸»è¦é—®é¢˜

1. **è€¦åˆé—®é¢˜**: `daily_sync_cn/hk.yml` å°†æ•°æ®åŒæ­¥å’Œ AI åˆ†æç»‘å®šåœ¨ä¸€èµ·
   - å¦‚æœæ•°æ®åŒæ­¥æˆåŠŸä½† AI åˆ†æå¤±è´¥ï¼Œéœ€è¦é‡è·‘æ•´ä¸ªæµç¨‹
   - æ— æ³•å•ç‹¬è§¦å‘ AI åˆ†æï¼ˆæ¯”å¦‚è¡¥è·‘ã€é‡æ–°åˆ†æï¼‰
   - ç¯å¢ƒå˜é‡é…ç½®åºå¤§ä¸”é‡å¤

2. **å‘½åä¸ä¸€è‡´**: 
   - `daily_sync.yml` vs `daily_sync_cn.yml` å‘½åæ··ä¹±
   - `realtime-sync.yml` ä½¿ç”¨è¿å­—ç¬¦ï¼Œå…¶ä»–ä½¿ç”¨ä¸‹åˆ’çº¿

3. **åºŸå¼ƒä»£ç **: `daily_sync.yml` æ³¨é‡Šè¯´å·²åºŸå¼ƒä½†ä»ä¿ç•™

---

## ğŸ¯ ä¼˜åŒ–æ–¹æ¡ˆ

### è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ª Workflow åªåšä¸€ä»¶äº‹
2. **å¯ç»„åˆ**: é€šè¿‡ `workflow_call` å®ç°å¤ç”¨
3. **å¯ç‹¬ç«‹è¿è¡Œ**: æ–¹ä¾¿è°ƒè¯•å’Œè¡¥è·‘
4. **å‘½åè§„èŒƒ**: ç»Ÿä¸€ä½¿ç”¨ä¸‹åˆ’çº¿ï¼ŒæŒ‰åŠŸèƒ½åˆ†ç±»

### æ–°æ¶æ„

```
.github/workflows/
â”œâ”€â”€ _shared/                    # å¯å¤ç”¨çš„ Composite Actions
â”‚   â””â”€â”€ setup_python.yml        # Python ç¯å¢ƒé…ç½® (å¯é€‰ï¼Œåç»­å®ç°)
â”‚
â”œâ”€â”€ ğŸ“Š æ•°æ®å±‚ (Data Layer)
â”‚   â”œâ”€â”€ data_sync_cn.yml        # Aè‚¡æ•°æ®åŒæ­¥ (ä»…åŒæ­¥ï¼Œä¸åˆ†æ)
â”‚   â”œâ”€â”€ data_sync_hk.yml        # æ¸¯è‚¡æ•°æ®åŒæ­¥ (ä»…åŒæ­¥ï¼Œä¸åˆ†æ)
â”‚   â”œâ”€â”€ data_sync_realtime.yml  # ç›˜ä¸­å®æ—¶åŒæ­¥
â”‚   â””â”€â”€ data_sync_single.yml    # å•è‚¡ç¥¨æŒ‰éœ€åŒæ­¥
â”‚
â”œâ”€â”€ ğŸ§  åˆ†æå±‚ (Analysis Layer)
â”‚   â”œâ”€â”€ ai_analyze_cn.yml       # Aè‚¡ AI åˆ†æ (ç‹¬ç«‹äºæ•°æ®åŒæ­¥)
â”‚   â”œâ”€â”€ ai_analyze_hk.yml       # æ¸¯è‚¡ AI åˆ†æ (ç‹¬ç«‹äºæ•°æ®åŒæ­¥)
â”‚   â””â”€â”€ ai_backfill.yml         # AI åˆ†æå›å¡« (å†å²è¡¥å……)
â”‚
â”œâ”€â”€ âš™ï¸ ç»´æŠ¤å±‚ (Maintenance Layer)
â”‚   â”œâ”€â”€ meta_sync.yml           # è‚¡ç¥¨å…ƒæ•°æ®åŒæ­¥
â”‚   â””â”€â”€ admin_codes.yml         # é‚€è¯·ç ç®¡ç†
â”‚
â””â”€â”€ ğŸ”— ç¼–æ’å±‚ (Orchestration Layer)
    â”œâ”€â”€ daily_pipeline_cn.yml   # Aè‚¡æ¯æ—¥å®Œæ•´æµæ°´çº¿ (è°ƒç”¨ data_sync + ai_analyze)
    â””â”€â”€ daily_pipeline_hk.yml   # æ¸¯è‚¡æ¯æ—¥å®Œæ•´æµæ°´çº¿ (è°ƒç”¨ data_sync + ai_analyze)
```

### å„å±‚èŒè´£

#### æ•°æ®å±‚ (Data Layer)
- ä»æ•°æ®æºæ‹‰å–è¡Œæƒ…æ•°æ®
- è®¡ç®—æŠ€æœ¯æŒ‡æ ‡
- å†™å…¥æ•°æ®åº“
- **ä¸åš AI åˆ†æ**

#### åˆ†æå±‚ (Analysis Layer)  
- è¯»å–æ•°æ®åº“ä¸­çš„æœ€æ–°æ•°æ®
- è°ƒç”¨ AI/è§„åˆ™å¼•æ“ç”Ÿæˆé¢„æµ‹
- å‘é€æ¨é€é€šçŸ¥
- **ä¸åšæ•°æ®åŒæ­¥**

#### ç»´æŠ¤å±‚ (Maintenance Layer)
- ä½é¢‘è¿è¡Œçš„ç»´æŠ¤ä»»åŠ¡
- å…ƒæ•°æ®æ›´æ–°ã€é‚€è¯·ç ç®¡ç†ç­‰

#### ç¼–æ’å±‚ (Orchestration Layer)
- ç»„åˆå¤šä¸ª Workflow å½¢æˆå®Œæ•´æµæ°´çº¿
- ä½¿ç”¨ `workflow_call` æˆ– `workflow_run` å®ç°

---

## ğŸ“… è°ƒåº¦æ—¶é—´è¡¨

### æ¯æ—¥å®šæ—¶ä»»åŠ¡

| æ—¶é—´ (åŒ—äº¬) | æ—¶é—´ (UTC)  | Workflow                | è¯´æ˜                 |
| ----------- | ----------- | ----------------------- | -------------------- |
| 06:00       | 22:00 (D-1) | `meta_sync.yml`         | åŒæ­¥è‚¡ç¥¨å…ƒæ•°æ®       |
| 16:00       | 08:00       | `daily_pipeline_cn.yml` | Aè‚¡æ”¶ç›˜åå®Œæ•´æµæ°´çº¿  |
| 16:30       | 08:30       | `daily_pipeline_hk.yml` | æ¸¯è‚¡æ”¶ç›˜åå®Œæ•´æµæ°´çº¿ |

### ç›˜ä¸­å®æ—¶ (ç”± Cloudflare Worker è§¦å‘)

| æ—¶é—´ (åŒ—äº¬) | é¢‘ç‡     | Workflow                 | è¯´æ˜         |
| ----------- | -------- | ------------------------ | ------------ |
| 09:30-15:00 | æ¯10åˆ†é’Ÿ | `data_sync_realtime.yml` | Aè‚¡ç›˜ä¸­åŒæ­¥  |
| 09:30-16:00 | æ¯10åˆ†é’Ÿ | `data_sync_realtime.yml` | æ¸¯è‚¡ç›˜ä¸­åŒæ­¥ |

### æ‰‹åŠ¨è§¦å‘

| Workflow               | ä½¿ç”¨åœºæ™¯             |
| ---------------------- | -------------------- |
| `data_sync_single.yml` | æ–°å¢è‚¡ç¥¨ã€å•è‚¡è¡¥æ•°æ® |
| `ai_backfill.yml`      | è¡¥è·‘å†å² AI åˆ†æ     |
| `ai_analyze_cn/hk.yml` | é‡æ–°è¿è¡Œå½“æ—¥åˆ†æ     |
| `admin_codes.yml`      | é‚€è¯·ç ç®¡ç†           |

---

## ğŸ”„ è¿ç§»è®¡åˆ’

### Phase 1: æ‹†åˆ† (è§£è€¦æ•°æ®åŒæ­¥ä¸AIåˆ†æ)

1. åˆ›å»º `data_sync_cn.yml` - ä»…æ•°æ®åŒæ­¥
2. åˆ›å»º `ai_analyze_cn.yml` - ä»… AI åˆ†æ
3. åˆ›å»º `daily_pipeline_cn.yml` - ç¼–æ’å±‚
4. å¯¹æ¸¯è‚¡åšç›¸åŒå¤„ç†

### Phase 2: æ¸…ç†

1. åˆ é™¤æ—§çš„ `daily_sync.yml`
2. é‡å‘½å `realtime-sync.yml` â†’ `data_sync_realtime.yml`
3. ç»Ÿä¸€å‘½åè§„èŒƒ

### Phase 3: å¢å¼º

1. æ·»åŠ  `ai_backfill.yml` æ”¯æŒå†å²è¡¥è·‘
2. è€ƒè™‘æ·»åŠ  Composite Actions å‡å°‘é‡å¤ä»£ç 
3. æ·»åŠ  Slack/ä¼å¾®é€šçŸ¥æ­¥éª¤

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨ `workflow_call` å®ç°å¤ç”¨

```yaml
# daily_pipeline_cn.yml
jobs:
  sync:
    uses: ./.github/workflows/data_sync_cn.yml
    secrets: inherit
  
  analyze:
    needs: sync
    if: success()
    uses: ./.github/workflows/ai_analyze_cn.yml
    secrets: inherit
```

### 2. ä½¿ç”¨ Concurrency é¿å…é‡å¤è¿è¡Œ

```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

### 3. ä½¿ç”¨ Matrix å‡å°‘é‡å¤

```yaml
strategy:
  matrix:
    market: [CN, HK]
```

### 4. ç¯å¢ƒå˜é‡åˆ†ç»„

```yaml
env:
  # æ•°æ®åº“é…ç½®
  TURSO_DB_URL: ${{ secrets.TURSO_DB_URL }}
  TURSO_AUTH_TOKEN: ${{ secrets.TURSO_AUTH_TOKEN }}
  
  # AI é…ç½® (ä»…åˆ†æä»»åŠ¡éœ€è¦)
  LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
```

---

## ğŸ“ å¾…åŠäº‹é¡¹

- [ ] Phase 1: æ‹†åˆ† daily_sync_cn/hk.yml
- [ ] Phase 2: æ¸…ç†åºŸå¼ƒæ–‡ä»¶å’Œç»Ÿä¸€å‘½å
- [ ] Phase 3: æ·»åŠ  ai_backfill.yml
- [ ] æ–‡æ¡£: æ›´æ–°æœ¬ README åæ˜ å®é™…çŠ¶æ€

---

*æœ€åæ›´æ–°: 2026-01-03*
